<?php

namespace Database\Seeders;

use App\Models\Coupon;
use App\Models\Scopes\CouponVisibleScope;
use App\Models\User;
use App\Services\ProcessCouponService;
use Carbon\Carbon;
use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;
use Illuminate\Support\Collection;

class CouponSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        $keys = collect([
            '31250329015820000139650010000706931113032270',
            '31250306949540000100650400001661811401262955',
            '31250309546798000146650040000154821401502504',
            '31250338469706000170650160003883581000329922',
            '31250364424245000129650070001501601560660544',
            '31250238469706000170650160003860361000298192',
            '31250106949540000100650400001616281305013311',
            '31250206949540000100650410001124391274543437',
            '31250139423453000166651010000398091156396366',
            '31250102834900000160651070000912231703592580',
            '31241223943039000148650010001028631018237793',
            '31250202834900000160651020001058331750299060',
            '31250238469706000170650230003364141001968917',
            '31250223943039000148650010001043801066413042',
            '31250229015820000139650010000658081787360111',
            '31250229015820000139650010000671171829319181',
            '31250106949540000100650400001616291745200109',
            '31241209546798000146650030000114751301482526',
            '31250223943039000148650010001049001015428656',
            '31241238469706000170650150004434901002224876',
            '31241106949540000100650420001431601489630535',
            '31241138469706000170650160003761551000160209',
            '31241029015820000139650030000655141983825544',
            '31240938469706000170650190006439121001052545',
            '31241209546798000146650030000114671301482184',
            '31241129015820000139650020000834959675447305',
            '31241206949540000100650400001594311585296922',
            '31241229015820000139650020000902321085872897',
            '31241138469706000170650160003771441000173760',
            '31241129015820000139650020000832421926001884',
            '31241122751077000217650240001081371952557656',
            '31241238469706000170650150004435151002225180',
            '31241038469706000170650170004113341000580161',
        ]);

        $user = User::query()->first();

        $data = collect();
        $keys->unique()->each(function ($key) use (&$data, $user) {
            $data->push([
                'user_id' => $user->id,
                'key' => $key,
                'visible' => false,
                'processed' => false,
                'processed_timestamp' => '',
                'created_at' => Carbon::now()->toDateTimeString(),
            ]);
        });

        Coupon::query()->insert($data->toArray());

        $coupons = Coupon::query()->withoutGlobalScopes([CouponVisibleScope::class])->get();
        new ProcessCouponService()->executeBatch($coupons);
    }
}
